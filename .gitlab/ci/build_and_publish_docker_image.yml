build_and_publish_docker_image:
  stage: build_and_publish_docker_image
  image: docker:24.0.5-dind
  tags:
    - docker-linux
  dependencies:
    - build_server
    - build_frontend
    - download_cli    
  script:
    - docker login -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"
    - docker build -t dadebia/codebox:${CI_COMMIT_TAG} .
    - docker push dadebia/codebox:${CI_COMMIT_TAG}

    # Tag and push docker image as latest only if is not a beta version
    - |
      if ! [[ $CI_COMMIT_TAG =~ ^.*beta.* ]] ; then
        docker tag dadebia/codebox:${CI_COMMIT_TAG} dadebia/codebox:latest
        docker push dadebia/codebox:latest;
      fi;
  when: on_success
  rules:
    - if: $CI_COMMIT_TAG
