# build_source
# This step contains two jobs:
# - build_server: this job is run only on tags, it builds the
# goland server binary.
# - build_frontend: this jobs is run on every commit an tag, it builds
# the react web app.

build_server:
  stage: build_sources
  image: golang:1.24.1
  tags:
    - docker-linux
  dependencies:
    - download_cli
    - retrieve_recommended_runner_version
  variables:
    GOOS: linux
    GOARCH: amd64
  script:
    - echo "Building codebox server version ${CI_COMMIT_TAG}"
    - echo "Using recommended runner version ${CODEBOX_RUNNER_VERSION}"
    - echo "Using recommended cli version ${CODEBOX_CLI_VERSION}"
    - mkdir -p bin
    - | 
      make build SERVER_VERSION=${CI_COMMIT_TAG} \
      RECOMMENDED_RUNNER_VERSION=${CODEBOX_RUNNER_VERSION} \
      RECOMMENDED_CLI_VERSION=${CODEBOX_CLI_VERSION}
  artifacts:
    paths:
      - bin/codebox
    expire_in: 1 hour
  when: on_success
  rules:
    - if: $CI_COMMIT_TAG

build_frontend:
  stage: build_sources
  image: node:20.12.2
  tags:
    - docker-linux
  script:
    - cd app
    - VERSION_TAG=$CI_COMMIT_TAG
    - |
      if [ -z $CI_COMMIT_TAG ]; then
        VERSION_TAG=debug
      fi
    - sed -i -e "s/{{ replace_me }}/$VERSION_TAG/g" .env.production
    - npm install
    - npm run build
  artifacts:
    paths:
      - app/build/
    expire_in: 1 hour
  when: on_success
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - if: '$CI_COMMIT_BRANCH == "master"'
      when: always
    - if: $CI_COMMIT_TAG
      when: always
