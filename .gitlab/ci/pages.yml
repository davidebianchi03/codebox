# This job builds the documentation.
# First, it generate APIs documentation using swagger, than
# it generate documentation site using sphinx
.build_pages_template:
  image: dadebia/codebox-release-cli:latest
  variables:
    LC_ALL: C.UTF-8
    LANG: C.UTF-8
  tags:
    - docker-linux
  script:
    # generate OpenAPI specification
    - sed -i "s/{{version_placeholder}}/${CI_COMMIT_TAG}/g" main.go
    - go install github.com/swaggo/swag/cmd/swag@latest
    - swag init
    - cp docs/swagger.json docs/source/_static

    # build docs using sphynx
    - python3 -m venv .venv
    - source .venv/bin/activate
    - pip install setuptools
    - pip install wheel
    - cd docs
    - pip install -r requirements.txt
    - sphinx-build -M html ./source ./build
    - cp -r ./build/html ../public

test_docs:
  extends: .build_pages_template
  stage: tests
  pages: false
  when: always
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: always
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: always
    - when: never

build_pages:
  extends: .build_pages_template
  stage: pages
  pages: true
  artifacts:
    paths:
      - public
  rules:
    - if: $CI_COMMIT_TAG
  when: always
