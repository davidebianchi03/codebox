# this job creates release both on gitlab and github
# for stable releases
release:
  stage: release
  image: dadebia/codebox-release-cli:latest
  tags:
    - docker-linux
  dependencies:
    - build_and_publish_docker_image
  script:
    - |
      if [[ "$CI_COMMIT_TAG" =~ -rc.*$ ]] || [[ "$CI_COMMIT_TAG" =~ -beta.*$ ]] || [[ "$CI_COMMIT_TAG" =~ -alpha.*$ ]]; then
        echo "Skipping pre-release tag: $CI_COMMIT_TAG"
        exit 0
      fi

    # generate release body
    - |
      git fetch --tags
      if git rev-parse --is-shallow-repository | grep -q true; then
        git fetch --unshallow
      fi
    - LATEST_TAG=$(git tag --list --sort=-creatordate | grep -vE '(-rc.*|-alpha.*|-beta.*)$' | head -2 | tail -n 1)
    - RELEASE_BODY=""
    - |
      if [ -z "$LATEST_TAG" ]; then
        echo "No suitable tag found."
      else
        echo "Latest tag: $LATEST_TAG"
        RELEASE_BODY=$(git diff --unified=0 "$LATEST_TAG" -- "./CHANGELOG.md" | grep '^+[^+]' | sed 's/^+//')
      fi

    - echo "Publishing release to gitlab..."
    - export GITLAB_HOST=$CI_SERVER_URL
    - glab auth login --job-token $CI_JOB_TOKEN --hostname $CI_SERVER_HOST --api-protocol $CI_SERVER_PROTOCOL
    - |
      if [ -z "$RELEASE_BODY" ]; then
        glab release create ${CI_COMMIT_TAG}
      else
        glab release create ${CI_COMMIT_TAG} --notes "$RELEASE_BODY"
      fi

    - echo "Publishing release to github..."
    - |
      http_code=$(curl -s -o /dev/null -w "%{http_code}" -L \
      -X POST \
      -H "Accept: application/vnd.github+json" \
      -H "Authorization: Bearer $GITHUB_TOKEN" \
      -H "X-GitHub-Api-Version: 2022-11-28" \
      https://api.github.com/repos/$GITHUB_MIRROR_REPO/releases \
      -d "{
        \"tag_name\":\"$CI_COMMIT_TAG\",
        \"target_commitish\":\"$CI_COMMIT_BRANCH\",
        \"name\":\"$CI_COMMIT_TAG\",
        \"body\":\"$RELEASE_BODY\",
        \"draft\":false,
        \"prerelease\":false,
        \"generate_release_notes\":false
      }")

      if [ "$http_code" -ne 201 ]; then
        echo "GitHub API request failed with HTTP code $http_code"
        exit 1
      fi
  rules:
    - if: $CI_COMMIT_TAG
      when: on_success
      